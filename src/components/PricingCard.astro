---
import Button from "./Button.astro"
import { pricingPlans } from "../data/pricingData"
---

<div class="pricing-scroll">
  <div class="pricing-track">
    {pricingPlans.map((plan, i) => (
      <article class={`pricing-card ${plan.popular ? "popular" : ""}`}>
        {plan.popular && <span class="badge">Популярный выбор</span>}

        <h3 class="card-title" style={`background:${plan.color}`}>
          {plan.title}
        </h3>

        <div class="features-wrapper" id={`features-${i}`}>
          <ul class="card-features">
            {plan.features.map(item => <li>{item}</li>)}
          </ul>
          <div class="fade" />
        </div>

        {plan.features.length > 5 && (
          <button class="toggle-btn" data-target={`features-${i}`}>
            Посмотреть ещё ↓
          </button>
        )}

        <footer class="card-footer">
          <Button
            href={`?tariff=${plan.id}#contact`}
            text="Купить сейчас"
            variant="primary"
            class="buy-now"
          />
          <p class="card-price">{plan.price}</p>
        </footer>
      </article>
    ))}
  </div>
</div>

<script lang="ts">
document.addEventListener("DOMContentLoaded", () => {
  const collapsedMax = 350

  document.querySelectorAll(".toggle-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const targetId = btn.getAttribute("data-target")
      if (!targetId) return

      const wrapper = document.getElementById(targetId)
      if (!wrapper) return

      const isExpanded = wrapper.classList.contains("expanded")

      if (!isExpanded) {
        wrapper.style.maxHeight = wrapper.scrollHeight + "px"
        wrapper.classList.add("expanded")
        btn.textContent = "Скрыть ↑"
        btn.setAttribute("aria-expanded", "true")

        const onTransitionEnd = (e) => {
          if ((e).propertyName === "max-height") {
            wrapper.style.maxHeight = "none"
            wrapper.removeEventListener("transitionend", onTransitionEnd)
          }
        }
        wrapper.addEventListener("transitionend", onTransitionEnd)
      } else {
        const current = wrapper.scrollHeight
        wrapper.style.maxHeight = current + "px"
        wrapper.offsetHeight
        wrapper.style.maxHeight = collapsedMax + "px"
        wrapper.classList.remove("expanded")

        btn.textContent = "Посмотреть ещё ↓"
        btn.setAttribute("aria-expanded", "false")
      }
    })
  })

  document.querySelectorAll(".buy-now").forEach((btn) => {
    btn.addEventListener("click", (e) => {
      e.preventDefault()

      const href = btn.getAttribute("href") || ""
      const newUrl = new URL(href, window.location.href)
      newUrl.hash = "contact"

      history.pushState({}, "", newUrl.toString())

      const target = document.getElementById("contact")
      if (target) target.scrollIntoView({ behavior: "smooth" })

      const tariff = newUrl.searchParams.get("tariff")
      window.dispatchEvent(new CustomEvent("urlchange", { detail: { tariff } }))
    })
  })
})
</script>


<style scoped>
  .pricing {
    --border-radius: var(--space-xs);
    --font-weight-semi: 600;
    --line-height: 100%;
  }

  .pricing-title {
    font-weight: var(--font-weight-semi);
    line-height: var(--line-height);
    font-size: var(--font-size-5);
    color: var(--clr-pink-400);
    text-align: center;
    margin-bottom: 2rem;
  }

  .pricing-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: var(--space-s);
    align-items: stretch;
  }

  .pricing-card {
    display: flex;
    flex-direction: column;
    background: var(--clr-white-smoke);
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
    padding-bottom: 1rem;
  }

  .card-title {
    border-top-left-radius: var(--border-radius);
    border-top-right-radius: var(--border-radius);
    font-size: var(--font-size-4);
    color: var(--clr-neutral-900);
    font-weight: var(--font-weight-semi);
    line-height: var(--line-height);
    text-align: center;
    margin: 0;
    padding: var(--space-m);
  }

  .features-wrapper {
    position: relative;
    max-height: 350px;
    overflow: hidden;
    transition: max-height 0.6s ease, padding 0.4s ease;
  }

  .features-wrapper.expanded .fade {
    opacity: 0;
  }

  .card-features {
    padding: 0 35px;
    display: flex;
    flex-direction: column;
    gap: var(--space-3xs-2xs);
    color: var(--clr-pink-800);
    list-style-type: none;
  }

  .card-features li::before {
    content: "•";
    color: var(--clr-pink-500);
    padding-right: var(--space-3xs);
  }

  .fade {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3rem;
    background: linear-gradient(to bottom, transparent, var(--clr-white-smoke));
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .features-wrapper.expanded .fade {
    opacity: 0;
  }

  .toggle-btn {
    background: none;
    border: none;
    color: var(--clr-pink-500);
    font-weight: 600;
    cursor: pointer;
    margin: 0.5rem auto;
    display: block;
    transition: color 0.2s ease;
  }

  .toggle-btn:hover {
    color: var(--clr-pink-500);
  }

  .card-footer {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.8rem;
  }

  .card-price {
    color: var(--clr-pink-500);
    font-weight: 600;
    font-size: var(--font-size-1);
  }

  .pricing-card {
    position: relative;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }

  .pricing-card.popular {
    border: 2px solid var(--clr-pink-500);
    transform: scale(1.04);
    box-shadow: 0 10px 20px rgba(255, 0, 120, 0.2);
    z-index: 2;
  }

  .pricing-card:hover {
    transform: scale(1.01);
  }

  .pricing-card.popular:hover {
    transform: scale(1.06);
  }

  .badge {
    position: absolute;
    top: -12px;
    right: -12px;
    background: var(--clr-pink-500);
    color: white;
    padding: 6px 12px;
    font-size: 0.8rem;
    font-weight: 600;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
  }

  @media (max-width: 700px) {

    .full-width {
      display: none;
    }
  .pricing-grid {
    grid-template-columns: 1fr;
    gap: var(--space-m);
    padding-inline: var(--space-xs);
  }

  .pricing-card {
    transform: none !important;
    box-shadow: 0 4px 14px rgba(0,0,0,0.08);
  }

  .pricing-card.popular {
    border-width: 1.5px;
  }

  .card-title {
    font-size: var(--font-size-3);
    padding: var(--space-s);
  }

  .card-features {
    padding-inline: var(--space-s);
  }

  .toggle-btn {
    font-size: 0.9rem;
    margin-top: 0.2rem;
  }

  .card-footer {
    gap: 0.5rem;
  }

  .card-price {
    font-size: var(--font-size-0);
  }
}

/* ---------- DESKTOP ---------- */
.pricing-scroll {
  container-type: inline-size;
}
.pricing-track {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--space-s);
}

/* ---------- MOBILE ---------- */
@container (max-width: 700px) {
  .pricing-scroll {
    overflow-x: auto;          /* горизонтальный скролл */
    scroll-snap-type: x mandatory;
    scrollbar-width: none;     /* Firefox */
  }
  .pricing-scroll::-webkit-scrollbar {
    display: none;             /* Chrome/Safari */
  }

  .pricing-track {
    display: flex;             /* лента */
    gap: var(--space-m);
    padding-inline: var(--space-xs);
  }

  .pricing-card {
    flex: 0 0 82cqi;           /* 82% ширины контейнера – видна часть след. карточки */
    scroll-snap-align: center;
    transform: none !important;
  }

  .pricing-card.popular {
    border-width: 2px;
  }
}

</style>

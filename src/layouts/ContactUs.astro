---
import { pricingPlans } from "../data/pricingData"
import Button from "../components/Button.astro"
---

<section id="contact" class="full-width">
  <h1 class="title">Пора услышать свой<br>внутренний голос!</h1>

  <form id="contact_us" class="contact">
    <div class="form-group">
      <label for="name" class="visually-hidden">Имя и фамилия</label>
      <input
        id="name"
        name="name"
        placeholder="Имя Фамилия"
        required
      />
    </div>

    <div class="form-group">
      <label for="phone" class="visually-hidden">Телефон</label>
      <input
        id="phone"
        name="phone"
        type="tel"
        placeholder="Телефон"
        required
      />
    </div>

    <div class="form-group">
      <label for="email" class="visually-hidden">Электронная почта</label>
      <input
        id="email"
        name="email"
        type="email"
        placeholder="Почта"
        required
      />
    </div>

    <div class="form-group">
      <label for="pricing-select" class="visually-hidden">Выбор тарифа</label>
      <select id="pricing-select" name="tariff" required>
        <option value="">Выберите тариф</option>
        {
          pricingPlans.map((plan) => (
            <option value={plan.id}>
              {plan.title} — {plan.price}
            </option>
          ))
        }
      </select>
    </div>

    <div id="form-message" class="form-msg" style="display: none;"></div>

    <div class="form-actions">
      <Button
        type="submit"
        text="Отправить заявку"
        variant="primary"
      />
    </div>
  </form>
</section>

<script is:inline>
  (function () {
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyVogQQxTwGuFqDp-b5y_lESjczS9ySyjs2LGt-i_eZc4PhH8hHN-LeWvjVUSPVqez3-A/exec";

    function applyTariffFromUrl(tariffFromEvent) {
      const select = document.getElementById("pricing-select");
      if (!select) return;

      const tariff =
        tariffFromEvent ??
        new URLSearchParams(window.location.search).get("tariff") ??
        "";
      const optionExists = Array.from(select.options).some(
        (o) => o.value === tariff,
      );
      if (optionExists) {
        select.value = tariff;
      } else {
        select.value = "";
      }
    }

    function setupFormHandling() {
      const form = document.getElementById("contact_us");
      const msgBox = document.getElementById("form-message");
      const submitBtn = form.querySelector('button[type="submit"]');
      
      if (!form) return;

      form.addEventListener("submit", async (e) => {
        e.preventDefault();
        
        const btnText = submitBtn.innerText;
        submitBtn.disabled = true;
        submitBtn.innerText = "Отправка...";
        msgBox.style.display = 'none';

        const formData = new FormData(form);
        const data = {
            name: formData.get("name"),
            phone: formData.get("phone"),
            email: formData.get("email"),
            tariff: formData.get("tariff") || "",
            date: new Date().toLocaleString("ru-RU")
        };

        try {
            await fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                body: JSON.stringify(data),
                headers: { "Content-Type": "text/plain;charset=utf-8" },
            });

            msgBox.className = "form-msg success";
            msgBox.innerText = "Спасибо! Ваша заявка отправлена.";
            msgBox.style.display = "block";
            form.reset();
            
            const url = new URL(window.location.href);
            url.search = "";
            window.history.replaceState({}, "", url);

        } catch (error) {
            console.error(error);
            msgBox.className = "form-msg error";
            msgBox.innerText = "Ошибка при отправке. Попробуйте написать нам в Telegram.";
            msgBox.style.display = "block";
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = btnText;
        }
      });
    }

    function init() {
      applyTariffFromUrl();
      setupFormHandling();
      window.addEventListener("urlchange", (e) => {
        const ce = e;
        applyTariffFromUrl(ce.detail?.tariff);
      });
      window.addEventListener("popstate", () => applyTariffFromUrl());
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
  
  window.addEventListener("astro:after-swap", () => {
    window.history.replaceState({}, "", window.location.pathname);
  });
</script>

<style>
  section {
    height: 100svh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-l);
  }

  .title {
    text-align: center;
    font-size: var(--font-size-4);
    color: var(--clr-pink-500);
    margin-bottom: var(--space-xl);
  }

  .contact {
    inline-size: 50%;
    background: var(--clr-white);
    padding: var(--space-l);
    border: 1px solid var(--clr-pink-400);
    border-radius: var(--space-xs);
    box-shadow: var(--box-shadow);
    display: flex;
    flex-direction: column;
    gap: var(--space-s);
    position: relative;
  }

  .form-actions {
    display: flex;
    justify-content: center;
    margin-top: var(--space-m);
  }

  input,
  select {
    width: 100%;
    padding: var(--space-s);
    font-size: var(--font-size-0);
    border: none;
    border-radius: var(--space-s);
    background: var(--clr-neutral-800);
    color: var(--clr-neutral-100);
  }

  select {
    cursor: pointer;
    border: 1px solid var(--clr-pink-400);
    appearance: none;
    background-image: url("data:image/svg+xml;utf8,<svg fill='%23d63384' xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path d='M7 10l5 5 5-5z'/></svg>");
    background-repeat: no-repeat;
    background-position: right var(--space-s) center;
    background-size: 2rem;
  }

  select:focus,
  input:focus {
    outline: none;
    border: 1px solid var(--clr-pink-500);
    box-shadow: 0 0 0 2px var(--clr-pink-200);
  }

  option {
    background: var(--clr-neutral-800);
    color: var(--clr-neutral-100);
    padding: var(--space-s);
    border-radius: var(--space-s);
    font-size: var(--font-size-0);
  }

  input::placeholder {
    color: var(--clr-neutral-400);
  }

  .form-msg {
    margin-top: var(--space-m);
    padding: var(--space-s);
    font-size: var(--font-size-1);
    border-radius: var(--space-xs);
    text-align: center;
    transition: all 0.3s ease;
  }

  .form-msg.success {
    color: var(--clr-green-500, hsl(140, 60%, 45%));
    background: hsla(140, 60%, 90%, 0.3);
    border: 1px solid var(--clr-green-400, hsl(140, 60%, 60%));
  }

  .form-msg.error {
    color: var(--clr-red-500, hsl(0, 70%, 55%));
    background: hsla(0, 70%, 90%, 0.3);
    border: 1px solid var(--clr-red-400, hsl(0, 70%, 65%));
  }

  .visually-hidden {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    border: 0;
  }

  /* Responsive */
  @media (max-width: 560px) {
    .contact {
      inline-size: 90%;
      padding: 1rem;
    }
    .title {
      font-size: 1.5rem;
    }
  }
</style>